<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroPay v3.0 [RETRO TERMINAL]</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'VT323', 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* CRT Screen Effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }

        /* Screen glow */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(0, 255, 0, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9998;
        }

        .terminal-container {
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            border: 4px solid #00ff00;
            box-shadow: 
                0 0 10px #00ff00,
                inset 0 0 20px rgba(0, 255, 0, 0.1);
            padding: 20px;
            position: relative;
        }

        .terminal-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }

        .terminal-title {
            font-size: 32px;
            letter-spacing: 4px;
            text-shadow: 0 0 10px #00ff00;
            animation: flicker 3s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
            51% { opacity: 1; }
        }

        .terminal-subtitle {
            font-size: 16px;
            color: #00cc00;
            margin-top: 5px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            max-width: 200px;
            padding: 10px 20px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'VT323', monospace;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .mode-btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 10px #00ff00;
        }

        .mode-btn.active {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }

        .ascii-border {
            border: 2px solid #00ff00;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .ascii-border::before {
            content: '╔═══════════════════════════════════════════════════════════╗';
            position: absolute;
            top: -12px;
            left: 0;
            right: 0;
            text-align: center;
            background: #000;
            font-size: 12px;
        }

        .prompt {
            color: #00ff00;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .prompt::before {
            content: 'user@zeropay:~$ ';
            color: #00cc00;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background: #00ff00;
            animation: blink 1s infinite;
            margin-left: 5px;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .step {
            text-align: center;
            flex: 1;
            padding: 10px;
            border: 1px solid #00ff00;
            position: relative;
        }

        .step.active {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px #00ff00;
        }

        .step.completed {
            background: rgba(0, 255, 0, 0.1);
        }

        .step::after {
            content: '→';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }

        .step:last-child::after {
            display: none;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'VT323', monospace;
            font-size: 20px;
            margin-bottom: 10px;
            outline: none;
        }

        .input-field:focus {
            box-shadow: 0 0 10px #00ff00;
        }

        .input-field::placeholder {
            color: #006600;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'VT323', monospace;
            font-size: 22px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn:hover:not(:disabled) {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-secondary {
            border-color: #00cc00;
            color: #00cc00;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #00cc00;
            color: #000;
            box-shadow: 0 0 10px #00cc00;
        }

        .factor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .factor-card {
            border: 2px solid #00ff00;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #000;
        }

        .factor-card:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 10px #00ff00;
        }

        .factor-card.selected {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px #00ff00;
        }

        .factor-card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #003300;
            color: #003300;
        }

        .factor-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .factor-name {
            font-size: 18px;
        }

        .canvas-container {
            border: 2px solid #00ff00;
            margin: 10px 0;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            cursor: crosshair;
        }

        .color-grid, .emoji-grid, .word-grid {
            display: grid;
            gap: 8px;
            margin: 10px 0;
        }

        .color-grid {
            grid-template-columns: repeat(6, 1fr);
        }

        .emoji-grid {
            grid-template-columns: repeat(6, 1fr);
        }

        .word-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .color-box, .emoji-box, .word-box {
            aspect-ratio: 1;
            border: 2px solid #00ff00;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #000;
        }

        .color-box:hover, .emoji-box:hover, .word-box:hover {
            box-shadow: 0 0 10px #00ff00;
        }

        .color-box.selected, .emoji-box.selected, .word-box.selected {
            border-color: #00ff00;
            box-shadow: 0 0 15px #00ff00;
            border-width: 4px;
        }

        .emoji-box {
            font-size: 28px;
        }

        .word-box {
            aspect-ratio: auto;
            min-height: 50px;
            font-size: 16px;
            padding: 5px;
        }

        .gateway-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .gateway-card {
            border: 2px solid #00ff00;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #000;
            position: relative;
        }

        .gateway-card:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 10px #00ff00;
        }

        .gateway-card.selected {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px #00ff00;
        }

        .gateway-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .gateway-name {
            font-size: 16px;
        }

        .success-screen {
            text-align: center;
            padding: 20px;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .success-title {
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff00;
        }

        .info-box {
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 15px 0;
            background: rgba(0, 255, 0, 0.05);
            font-size: 18px;
            line-height: 1.6;
        }

        .error-message {
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 18px;
        }

        .progress-bar {
            height: 30px;
            border: 2px solid #00ff00;
            margin: 10px 0;
            position: relative;
            background: #000;
        }

        .progress-fill {
            height: 100%;
            background: #00ff00;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }

        .timer {
            text-align: center;
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff00;
        }

        .timer.warning {
            color: #ff9900;
            animation: pulse 1s infinite;
        }

        .rhythm-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .rhythm-circle {
            width: 80px;
            height: 80px;
            border: 3px solid #00ff00;
            background: #000;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .rhythm-circle:active {
            transform: scale(0.9);
        }

        .rhythm-circle.blink {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }

        .image-tap-container {
            position: relative;
            border: 2px solid #00ff00;
            margin: 10px auto;
            max-width: 400px;
            cursor: pointer;
            background: #000;
        }

        .image-tap-svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .tap-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #00ff00;
            background: rgba(0, 255, 0, 0.3);
            pointer-events: none;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tap-indicator.show {
            opacity: 1;
            animation: ripple 0.6s;
        }

        @keyframes ripple {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .consent-toggle {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 2px solid #00ff00;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #000;
        }

        .consent-toggle:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .consent-toggle.checked {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px #00ff00;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #00ff00;
            background: #000;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
        }

        .checkbox.checked::after {
            content: 'X';
            color: #00ff00;
            font-size: 18px;
        }

        .ascii-art {
            white-space: pre;
            font-size: 12px;
            line-height: 1;
            color: #00ff00;
            text-align: center;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            font-size: 24px;
            padding: 20px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== CONSTANTS ====================
        
        const FACTORS = [
            // Available factors
            { id: 'PIN', name: 'PIN', icon: '[#]', category: 'knowledge', available: true },
            { id: 'PATTERN', name: 'Pattern', icon: '[~]', category: 'knowledge', available: true },
            { id: 'WORDS', name: 'Words', icon: '[A]', category: 'knowledge', available: true },
            { id: 'COLOUR', name: 'Colours', icon: '[*]', category: 'knowledge', available: true },
            { id: 'EMOJI', name: 'Emoji', icon: '[:]', category: 'knowledge', available: true },
            { id: 'RHYTHM_TAP', name: 'Tap Rhythm', icon: '[♪]', category: 'behavioral', available: true },
            { id: 'IMAGE_TAP', name: 'Image Tap', icon: '[◘]', category: 'behavioral', available: true },
            
            // Not available yet
            { id: 'FACE', name: 'Face', icon: '[O]', category: 'biometric', available: false },
            { id: 'FINGERPRINT', name: 'Fingerprint', icon: '[Θ]', category: 'biometric', available: false },
            { id: 'VOICE', name: 'Voice', icon: '[♫]', category: 'biometric', available: false },
            { id: 'MOUSE_DRAW', name: 'Mouse Draw', icon: '[▼]', category: 'behavioral', available: false },
            { id: 'STYLUS_DRAW', name: 'Stylus Draw', icon: '[✎]', category: 'behavioral', available: false },
            { id: 'NFC', name: 'NFC', icon: '[N]', category: 'possession', available: false },
            { id: 'BALANCE', name: 'Balance', icon: '[⚖]', category: 'location', available: false },
        ];

        const PAYMENT_GATEWAYS = [
            { id: 'alipay', name: 'Alipay', icon: '[A]', color: '#1677FF' },
            { id: 'payu', name: 'PayU', icon: '[P]', color: '#66C351' },
            { id: 'stripe', name: 'Stripe', icon: '[S]', color: '#635BFF' },
            { id: 'adyen', name: 'Adyen', icon: '[Y]', color: '#0ABF53' },
            { id: 'googlepay', name: 'Google Pay', icon: '[G]', color: '#4285F4' },
            { id: 'applepay', name: 'Apple Pay', icon: '[∆]', color: '#000000' },
            { id: 'paypal', name: 'PayPal', icon: '[PP]', color: '#003087' },
            { id: 'square', name: 'Square', icon: '[■]', color: '#3E4348' },
            { id: 'braintree', name: 'Braintree', icon: '[B]', color: '#00C9FF' },
            { id: 'mercadopago', name: 'Mercado Pago', icon: '[M]', color: '#009EE3' },
            { id: 'twocheckout', name: '2Checkout', icon: '[2]', color: '#0099CC' },
            { id: 'phantom', name: 'Phantom', icon: '[Φ]', color: '#AB9FF2' },
            { id: 'yappy', name: 'Yappy', icon: '[Y]', color: '#FF6B35' },
            { id: 'nequi', name: 'Nequi', icon: '[N]', color: '#5E17EB' },
        ];

        const COLORS = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FF8800', '#88FF00', '#00FF88', '#8800FF', '#FF0088', '#0088FF',
            '#FF4444', '#44FF44', '#4444FF', '#FFFF44', '#FF44FF', '#44FFFF'
        ];

        const ALL_EMOJIS = [
            '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃',
            '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙',
            '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔',
            '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥',
            '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮'
        ];

        const WORD_LIST = [
            'apple', 'banana', 'cherry', 'dragon', 'eagle', 'falcon',
            'giraffe', 'horse', 'iguana', 'jaguar', 'koala', 'lion',
            'monkey', 'narwhal', 'octopus', 'panda', 'quail', 'rabbit',
            'snake', 'tiger', 'unicorn', 'vulture', 'whale', 'xerus',
            'yak', 'zebra', 'anchor', 'bridge', 'castle', 'diamond',
            'emerald', 'forest', 'galaxy', 'harbor', 'island', 'jungle'
        ];

        // ==================== IN-MEMORY STORAGE ====================
        
        if (!window.zeropayEnrollmentData) {
            window.zeropayEnrollmentData = null;
        }
        
        const enrollmentStorage = {
            save(enrollmentData) {
                window.zeropayEnrollmentData = enrollmentData;
                console.log('✅ Enrollment saved to window.zeropayEnrollmentData:', enrollmentData);
                console.log('📋 UUID:', enrollmentData.uuid);
                console.log('🏷️ Alias:', enrollmentData.alias);
            },
            
            get(uuidOrAlias) {
                console.log('🔍 Looking for UUID or Alias:', uuidOrAlias);
                console.log('💾 Current stored data:', window.zeropayEnrollmentData);
                
                if (!window.zeropayEnrollmentData) {
                    console.log('❌ No enrollment data in memory');
                    return null;
                }
                
                const matchesUuid = window.zeropayEnrollmentData.uuid === uuidOrAlias;
                const matchesAlias = window.zeropayEnrollmentData.alias === uuidOrAlias;
                
                if (matchesUuid || matchesAlias) {
                    console.log('✅ Enrollment found! Matched by:', matchesUuid ? 'UUID' : 'Alias');
                    return window.zeropayEnrollmentData;
                }
                
                console.log('❌ No enrollment found for:', uuidOrAlias);
                return null;
            },
            
            clear() {
                window.zeropayEnrollmentData = null;
                console.log('🗑️ Enrollment cleared from memory');
            }
        };

        // ==================== UTILITY FUNCTIONS ====================

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateAlias(uuid) {
            const adjectives = ['Red', 'Blue', 'Gold', 'Zen', 'Ace', 'Max', 'Neo', 'Sky'];
            const nouns = ['Fox', 'Cat', 'Owl', 'Bee', 'Jay', 'Elk', 'Pup', 'Bat'];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const num = Math.floor(Math.random() * 99);
            return `${adjective}${noun}${num}`;
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function patternsAreSimilar(pattern1, pattern2, tolerance = 30) {
            if (Math.abs(pattern1.length - pattern2.length) > pattern1.length * 0.3) {
                return false;
            }

            const sampleCount = Math.min(pattern1.length, pattern2.length, 20);
            const step1 = pattern1.length / sampleCount;
            const step2 = pattern2.length / sampleCount;

            let totalDistance = 0;
            let validPoints = 0;

            for (let i = 0; i < sampleCount; i++) {
                const idx1 = Math.floor(i * step1);
                const idx2 = Math.floor(i * step2);

                if (idx1 < pattern1.length && idx2 < pattern2.length) {
                    const p1 = pattern1[idx1];
                    const p2 = pattern2[idx2];
                    const distance = Math.sqrt(
                        Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)
                    );
                    totalDistance += distance;
                    validPoints++;
                }
            }

            const averageDistance = totalDistance / validPoints;
            console.log(`📏 Pattern similarity check: avg distance = ${averageDistance.toFixed(2)}px (tolerance = ${tolerance}px)`);
            
            return averageDistance <= tolerance;
        }

        // ==================== MAIN APP COMPONENT ====================

        function App() {
            const [mode, setMode] = useState('enrollment');
            
            return (
                <div className="terminal-container">
                    <div className="terminal-header">
                        <div className="terminal-title">
                            ╔══════════════════════════════════╗
                            <br/>
                            ║   ZEROPAY v3.0 [RETRO MODE]    ║
                            <br/>
                            ╚══════════════════════════════════╝
                        </div>
                        <div className="terminal-subtitle">
                            &gt;&gt; DEVICE-FREE AUTHENTICATION ENGINE &lt;&lt;
                        </div>
                    </div>
                    
                    <div className="mode-toggle">
                        <button 
                            className={`mode-btn ${mode === 'enrollment' ? 'active' : ''}`}
                            onClick={() => setMode('enrollment')}
                        >
                            [ENROLL]
                        </button>
                        <button 
                            className={`mode-btn ${mode === 'merchant' ? 'active' : ''}`}
                            onClick={() => setMode('merchant')}
                        >
                            [MERCHANT]
                        </button>
                    </div>
                    
                    {mode === 'enrollment' ? <EnrollmentFlow /> : <MerchantFlow />}
                </div>
            );
        }

        // ==================== ENROLLMENT FLOW ====================

        function EnrollmentFlow() {
            const [step, setStep] = useState(1);
            const [selectedFactors, setSelectedFactors] = useState([]);
            const [factorData, setFactorData] = useState({});
            const [selectedGateways, setSelectedGateways] = useState([]);
            const [showGatewayAuth, setShowGatewayAuth] = useState(false);
            const [authingGateway, setAuthingGateway] = useState(null);
            const [consentGiven, setConsentGiven] = useState(false);
            const [uuid, setUuid] = useState(null);
            const [alias, setAlias] = useState(null);

            const handleFactorSelect = (factorId) => {
                const factor = FACTORS.find(f => f.id === factorId);
                if (!factor || !factor.available) return;
                
                if (selectedFactors.includes(factorId)) {
                    setSelectedFactors(selectedFactors.filter(f => f !== factorId));
                } else {
                    const availableCount = FACTORS.filter(f => f.available).length;
                    if (selectedFactors.length < availableCount) {
                        setSelectedFactors([...selectedFactors, factorId]);
                    }
                }
            };

            const handleFactorDataSubmit = async (factorId, data) => {
                const digest = await sha256(JSON.stringify(data));
                setFactorData({
                    ...factorData,
                    [factorId]: { rawData: data, digest }
                });
            };

            const handleGatewaySelect = (gatewayId) => {
                if (selectedGateways.includes(gatewayId)) {
                    setSelectedGateways(selectedGateways.filter(g => g !== gatewayId));
                } else {
                    const gateway = PAYMENT_GATEWAYS.find(g => g.id === gatewayId);
                    setAuthingGateway(gateway);
                    setShowGatewayAuth(true);
                    
                    setTimeout(() => {
                        setSelectedGateways([...selectedGateways, gatewayId]);
                        setShowGatewayAuth(false);
                        setAuthingGateway(null);
                    }, 2000);
                }
            };

            const handleEnrollmentComplete = async () => {
                const newUuid = generateUUID();
                const newAlias = generateAlias(newUuid);
                
                const enrollmentData = {
                    uuid: newUuid,
                    alias: newAlias,
                    factors: factorData,
                    gateways: selectedGateways,
                    timestamp: new Date().toISOString()
                };
                
                enrollmentStorage.save(enrollmentData);
                
                setUuid(newUuid);
                setAlias(newAlias);
                setStep(5);
            };

            const resetEnrollment = () => {
                setStep(1);
                setSelectedFactors([]);
                setFactorData({});
                setSelectedGateways([]);
                setShowGatewayAuth(false);
                setAuthingGateway(null);
                setConsentGiven(false);
                setUuid(null);
                setAlias(null);
            };

            return (
                <>
                    {step < 5 && (
                        <div className="step-indicator">
                            {[1, 2, 3, 4, 5].map(num => (
                                <div key={num} className={`step ${step === num ? 'active' : step > num ? 'completed' : ''}`}>
                                    [{num}] {num === 1 && 'SELECT'}
                                    {num === 2 && 'CAPTURE'}
                                    {num === 3 && 'PAYMENT'}
                                    {num === 4 && 'CONSENT'}
                                    {num === 5 && 'DONE'}
                                </div>
                            ))}
                        </div>
                    )}

                    {step === 1 && (
                        <Step1FactorSelection 
                            selectedFactors={selectedFactors}
                            onFactorSelect={handleFactorSelect}
                            onNext={() => setStep(2)}
                        />
                    )}

                    {step === 2 && (
                        <Step2FactorCapture 
                            selectedFactors={selectedFactors}
                            factorData={factorData}
                            onFactorDataSubmit={handleFactorDataSubmit}
                            onBack={() => setStep(1)}
                            onNext={() => setStep(3)}
                        />
                    )}

                    {step === 3 && (
                        <Step3PaymentLinking 
                            selectedGateways={selectedGateways}
                            showGatewayAuth={showGatewayAuth}
                            authingGateway={authingGateway}
                            onGatewaySelect={handleGatewaySelect}
                            onBack={() => setStep(2)}
                            onNext={() => setStep(4)}
                        />
                    )}

                    {step === 4 && (
                        <Step4Consent 
                            consentGiven={consentGiven}
                            onConsentChange={setConsentGiven}
                            onBack={() => setStep(3)}
                            onComplete={handleEnrollmentComplete}
                        />
                    )}

                    {step === 5 && (
                        <Step5Confirmation 
                            uuid={uuid}
                            alias={alias}
                            factorCount={selectedFactors.length}
                            gateways={selectedGateways}
                            onReset={resetEnrollment}
                        />
                    )}
                </>
            );
        }

        // ==================== ENROLLMENT STEPS ====================

        function Step1FactorSelection({ selectedFactors, onFactorSelect, onNext }) {
            const availableFactors = FACTORS.filter(f => f.available);
            const unavailableFactors = FACTORS.filter(f => !f.available);
            const minRequired = 6;
            const canProceed = selectedFactors.length >= minRequired;
            
            return (
                <div className="ascii-border">
                    <div className="prompt">STEP 1: SELECT AUTHENTICATION FACTORS</div>
                    <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '16px' }}>
                        &gt; MINIMUM {minRequired} FACTORS REQUIRED (PSD3 SCA) &lt;
                    </div>
                    
                    <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '18px', marginBottom: '10px' }}>
                            ═══ AVAILABLE FACTORS ═══
                        </div>
                        <div className="factor-grid">
                            {availableFactors.map(factor => (
                                <div
                                    key={factor.id}
                                    className={`factor-card ${selectedFactors.includes(factor.id) ? 'selected' : ''}`}
                                    onClick={() => onFactorSelect(factor.id)}
                                >
                                    <div className="factor-icon">{factor.icon}</div>
                                    <div className="factor-name">{factor.name}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {unavailableFactors.length > 0 && (
                        <div>
                            <div style={{ fontSize: '18px', marginBottom: '10px', color: '#006600' }}>
                                ═══ COMING SOON ═══
                            </div>
                            <div className="factor-grid">
                                {unavailableFactors.map(factor => (
                                    <div
                                        key={factor.id}
                                        className="factor-card disabled"
                                    >
                                        <div className="factor-icon">{factor.icon}</div>
                                        <div className="factor-name">{factor.name}</div>
                                        <div style={{ fontSize: '12px', marginTop: '5px' }}>
                                            [LOCKED]
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div style={{ textAlign: 'center', margin: '15px 0', fontSize: '20px' }}>
                        &gt;&gt; SELECTED: {selectedFactors.length}/{availableFactors.length} &lt;&lt;
                        {selectedFactors.length < minRequired && (
                            <div style={{ color: '#ff9900', fontSize: '16px', marginTop: '5px' }}>
                                [!] NEED {minRequired - selectedFactors.length} MORE FOR SECURITY
                            </div>
                        )}
                    </div>

                    {!canProceed && selectedFactors.length > 0 && (
                        <div className="error-message">
                            [ERROR] MINIMUM {minRequired} FACTORS REQUIRED FOR PSD3 SCA COMPLIANCE
                        </div>
                    )}

                    <button 
                        className="btn" 
                        disabled={!canProceed}
                        onClick={onNext}
                    >
                        [CONTINUE] → FACTOR CAPTURE
                    </button>
                </div>
            );
        }

        function Step2FactorCapture({ selectedFactors, factorData, onFactorDataSubmit, onBack, onNext }) {
            const [currentFactorIndex, setCurrentFactorIndex] = useState(0);
            const currentFactorId = selectedFactors[currentFactorIndex];
            const currentFactor = FACTORS.find(f => f.id === currentFactorId);

            const handleNext = () => {
                if (currentFactorIndex < selectedFactors.length - 1) {
                    setCurrentFactorIndex(currentFactorIndex + 1);
                } else {
                    onNext();
                }
            };

            const handleBack = () => {
                if (currentFactorIndex > 0) {
                    setCurrentFactorIndex(currentFactorIndex - 1);
                } else {
                    onBack();
                }
            };

            const isFactorComplete = factorData[currentFactorId] !== undefined;
            const progress = ((currentFactorIndex + 1) / selectedFactors.length) * 100;

            return (
                <div className="ascii-border">
                    <div className="prompt">STEP 2: CAPTURE FACTORS</div>
                    <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '18px' }}>
                        &gt; FACTOR {currentFactorIndex + 1} OF {selectedFactors.length}: {currentFactor.name.toUpperCase()} &lt;
                    </div>

                    <div className="progress-bar">
                        <div className="progress-fill" style={{ width: `${progress}%` }}>
                            {Math.round(progress)}%
                        </div>
                    </div>

                    <FactorCaptureComponent 
                        factor={currentFactor}
                        onSubmit={(data) => onFactorDataSubmit(currentFactorId, data)}
                        isComplete={isFactorComplete}
                    />

                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button className="btn btn-secondary" onClick={handleBack}>
                            ← [BACK]
                        </button>
                        <button 
                            className="btn" 
                            disabled={!isFactorComplete}
                            onClick={handleNext}
                        >
                            {currentFactorIndex < selectedFactors.length - 1 ? '[NEXT FACTOR] →' : '[CONTINUE] → PAYMENT'}
                        </button>
                    </div>
                </div>
            );
        }

        function Step3PaymentLinking({ selectedGateways, showGatewayAuth, authingGateway, onGatewaySelect, onBack, onNext }) {
            return (
                <div className="ascii-border">
                    <div className="prompt">STEP 3: LINK PAYMENT METHOD(S)</div>
                    <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '16px' }}>
                        &gt; SELECT ONE OR MORE PAYMENT PROVIDERS &lt;
                    </div>

                    {showGatewayAuth && authingGateway && (
                        <div className="info-box" style={{ textAlign: 'center' }}>
                            <div className="loading">
                                CONNECTING TO {authingGateway.name.toUpperCase()}
                            </div>
                            <div style={{ fontSize: '16px', marginTop: '10px' }}>
                                [AUTHENTICATING...]
                            </div>
                        </div>
                    )}

                    <div className="gateway-grid">
                        {PAYMENT_GATEWAYS.map(gateway => (
                            <div
                                key={gateway.id}
                                className={`gateway-card ${selectedGateways.includes(gateway.id) ? 'selected' : ''}`}
                                onClick={() => onGatewaySelect(gateway.id)}
                            >
                                <div className="gateway-icon">{gateway.icon}</div>
                                <div className="gateway-name">{gateway.name}</div>
                                {selectedGateways.includes(gateway.id) && (
                                    <div style={{ fontSize: '12px', marginTop: '5px' }}>
                                        [OK]
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    <div style={{ textAlign: 'center', margin: '15px 0', fontSize: '18px' }}>
                        &gt;&gt; CONNECTED: {selectedGateways.length} GATEWAY{selectedGateways.length !== 1 ? 'S' : ''} &lt;&lt;
                    </div>

                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button className="btn btn-secondary" onClick={onBack}>
                            ← [BACK]
                        </button>
                        <button 
                            className="btn" 
                            disabled={selectedGateways.length === 0}
                            onClick={onNext}
                        >
                            [CONTINUE] → CONSENT
                        </button>
                    </div>
                </div>
            );
        }

        function Step4Consent({ consentGiven, onConsentChange, onBack, onComplete }) {
            const [dataProcessing, setDataProcessing] = useState(false);
            const [factorStorage, setFactorStorage] = useState(false);
            const [paymentLinking, setPaymentLinking] = useState(false);

            useEffect(() => {
                const allConsentsGiven = dataProcessing && factorStorage && paymentLinking;
                if (allConsentsGiven !== consentGiven) {
                    onConsentChange(allConsentsGiven);
                }
            }, [dataProcessing, factorStorage, paymentLinking]);

            return (
                <div className="ascii-border">
                    <div className="prompt">STEP 4: GDPR CONSENT</div>
                    <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '16px' }}>
                        &gt; PRIVACY & SECURITY AGREEMENT &lt;
                    </div>

                    <div style={{ marginBottom: '15px' }}>
                        <div 
                            className={`consent-toggle ${dataProcessing ? 'checked' : ''}`}
                            onClick={() => setDataProcessing(!dataProcessing)}
                        >
                            <div className={`checkbox ${dataProcessing ? 'checked' : ''}`}></div>
                            <div>
                                <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>DATA PROCESSING</div>
                                <div style={{ fontSize: '14px' }}>We process SHA-256 hashes. No raw data stored.</div>
                            </div>
                        </div>

                        <div 
                            className={`consent-toggle ${factorStorage ? 'checked' : ''}`}
                            onClick={() => setFactorStorage(!factorStorage)}
                        >
                            <div className={`checkbox ${factorStorage ? 'checked' : ''}`}></div>
                            <div>
                                <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>FACTOR STORAGE</div>
                                <div style={{ fontSize: '14px' }}>Digests cached in Redis for 24h, then deleted.</div>
                            </div>
                        </div>

                        <div 
                            className={`consent-toggle ${paymentLinking ? 'checked' : ''}`}
                            onClick={() => setPaymentLinking(!paymentLinking)}
                        >
                            <div className={`checkbox ${paymentLinking ? 'checked' : ''}`}></div>
                            <div>
                                <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>PAYMENT LINKING</div>
                                <div style={{ fontSize: '14px' }}>Tokens encrypted with AES-256-GCM.</div>
                            </div>
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '10px' }}>
                        <button className="btn btn-secondary" onClick={onBack}>
                            ← [BACK]
                        </button>
                        <button 
                            className="btn" 
                            disabled={!consentGiven}
                            onClick={onComplete}
                        >
                            [COMPLETE ENROLLMENT]
                        </button>
                    </div>
                </div>
            );
        }

        function Step5Confirmation({ uuid, alias, factorCount, gateways, onReset }) {
            return (
                <div className="success-screen">
                    <div className="ascii-art">
{`
███████╗██╗   ██╗ ██████╗ ██████╗███████╗███████╗███████╗
██╔════╝██║   ██║██╔════╝██╔════╝██╔════╝██╔════╝██╔════╝
███████╗██║   ██║██║     ██║     █████╗  ███████╗███████╗
╚════██║██║   ██║██║     ██║     ██╔══╝  ╚════██║╚════██║
███████║╚██████╔╝╚██████╗╚██████╗███████╗███████║███████║
╚══════╝ ╚═════╝  ╚═════╝ ╚═════╝╚══════╝╚══════╝╚══════╝
`}
                    </div>
                    <div className="success-title">[ENROLLMENT COMPLETE]</div>
                    
                    <div className="info-box" style={{ textAlign: 'left' }}>
                        <div style={{ marginBottom: '10px' }}>
                            <strong>UUID:</strong><br/>
                            {uuid}
                        </div>
                        <div style={{ marginBottom: '10px' }}>
                            <strong>ALIAS:</strong><br/>
                            {alias}
                        </div>
                        <div style={{ marginBottom: '10px' }}>
                            <strong>FACTORS:</strong> {factorCount} enrolled
                        </div>
                        <div>
                            <strong>GATEWAYS:</strong> {gateways.map(gId => PAYMENT_GATEWAYS.find(g => g.id === gId)?.name).join(', ')}
                        </div>
                    </div>

                    <div style={{ textAlign: 'center', margin: '15px 0', fontSize: '16px' }}>
                        [i] Data encrypted and cached (24h TTL)<br/>
                        [i] Ready for device-free authentication<br/>
                        [i] Use UUID or Alias at any merchant
                    </div>

                    <button className="btn" onClick={onReset}>
                        [ENROLL ANOTHER USER]
                    </button>
                </div>
            );
        }

        // ==================== FACTOR CAPTURE COMPONENTS ====================

        function FactorCaptureComponent({ factor, onSubmit, isComplete }) {
            switch (factor.id) {
                case 'PIN':
                    return <PinCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'PATTERN':
                    return <PatternCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'WORDS':
                    return <WordsCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'COLOUR':
                    return <ColorCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'EMOJI':
                    return <EmojiCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'RHYTHM_TAP':
                    return <RhythmTapCapture onSubmit={onSubmit} isComplete={isComplete} />;
                case 'IMAGE_TAP':
                    return <ImageTapCapture onSubmit={onSubmit} isComplete={isComplete} mode="enrollment" />;
                default:
                    return <GenericCapture factor={factor} onSubmit={onSubmit} isComplete={isComplete} />;
            }
        }

        function PinCapture({ onSubmit, isComplete }) {
            const [pin, setPin] = useState('');

            const handleSubmit = () => {
                if (pin.length >= 4) {
                    onSubmit(pin);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; ENTER 4-12 DIGIT PIN
                    </div>
                    <input
                        type="password"
                        className="input-field"
                        placeholder="[PIN CODE]"
                        value={pin}
                        onChange={(e) => setPin(e.target.value.replace(/\D/g, '').slice(0, 12))}
                        maxLength={12}
                        disabled={isComplete}
                    />
                    {!isComplete && (
                        <button 
                            className="btn" 
                            disabled={pin.length < 4}
                            onClick={handleSubmit}
                        >
                            [SAVE PIN]
                        </button>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] PIN SAVED
                        </div>
                    )}
                </div>
            );
        }

        function PatternCapture({ onSubmit, isComplete }) {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [pattern, setPattern] = useState([]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = 300;
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }, []);

            const startDrawing = (e) => {
                if (isComplete) return;
                setIsDrawing(true);
                const point = getPoint(e);
                setPattern([point]);
            };

            const draw = (e) => {
                if (!isDrawing || isComplete) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const point = getPoint(e);
                
                setPattern(prev => [...prev, point]);
                
                if (pattern.length > 0) {
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(pattern[pattern.length - 1].x, pattern[pattern.length - 1].y);
                    ctx.lineTo(point.x, point.y);
                    ctx.stroke();
                }
            };

            const stopDrawing = () => {
                setIsDrawing(false);
            };

            const getPoint = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const handleClear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                setPattern([]);
            };

            const handleSubmit = () => {
                if (pattern.length >= 3) {
                    onSubmit(pattern);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; DRAW YOUR PATTERN (MIN 3 STROKES)
                    </div>
                    <div className="canvas-container">
                        <canvas
                            ref={canvasRef}
                            onMouseDown={startDrawing}
                            onMouseMove={draw}
                            onMouseUp={stopDrawing}
                            onMouseLeave={stopDrawing}
                            onTouchStart={startDrawing}
                            onTouchMove={draw}
                            onTouchEnd={stopDrawing}
                        />
                    </div>
                    {!isComplete && (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="btn btn-secondary" onClick={handleClear}>
                                [CLEAR]
                            </button>
                            <button 
                                className="btn" 
                                disabled={pattern.length < 3}
                                onClick={handleSubmit}
                            >
                                [SAVE PATTERN]
                            </button>
                        </div>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] PATTERN SAVED
                        </div>
                    )}
                </div>
            );
        }

        function WordsCapture({ onSubmit, isComplete }) {
            const [selectedWords, setSelectedWords] = useState([]);
            const [availableWords] = useState(WORD_LIST.slice(0, 18));

            const handleWordClick = (word) => {
                if (isComplete) return;
                if (selectedWords.includes(word)) {
                    setSelectedWords(selectedWords.filter(w => w !== word));
                } else if (selectedWords.length < 4) {
                    setSelectedWords([...selectedWords, word]);
                }
            };

            const handleSubmit = () => {
                if (selectedWords.length === 4) {
                    onSubmit(selectedWords);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT 4 WORDS TO REMEMBER
                    </div>
                    <div className="word-grid">
                        {availableWords.map(word => (
                            <div
                                key={word}
                                className={`word-box ${selectedWords.includes(word) ? 'selected' : ''}`}
                                onClick={() => handleWordClick(word)}
                                style={{ opacity: isComplete ? 0.5 : 1, cursor: isComplete ? 'default' : 'pointer' }}
                            >
                                {word.toUpperCase()}
                            </div>
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedWords.length}/4 &lt;&lt;
                    </div>
                    {!isComplete && (
                        <button 
                            className="btn" 
                            disabled={selectedWords.length !== 4}
                            onClick={handleSubmit}
                        >
                            [SAVE WORDS]
                        </button>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] WORDS SAVED
                        </div>
                    )}
                </div>
            );
        }

        function ColorCapture({ onSubmit, isComplete }) {
            const [selectedColors, setSelectedColors] = useState([]);

            const handleColorClick = (color) => {
                if (isComplete) return;
                if (selectedColors.includes(color)) {
                    setSelectedColors(selectedColors.filter(c => c !== color));
                } else if (selectedColors.length < 6) {
                    setSelectedColors([...selectedColors, color]);
                }
            };

            const handleSubmit = () => {
                if (selectedColors.length >= 3) {
                    onSubmit(selectedColors);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT 3-6 COLORS
                    </div>
                    <div className="color-grid">
                        {COLORS.map(color => (
                            <div
                                key={color}
                                className={`color-box ${selectedColors.includes(color) ? 'selected' : ''}`}
                                style={{ 
                                    backgroundColor: color,
                                    opacity: isComplete ? 0.5 : 1,
                                    cursor: isComplete ? 'default' : 'pointer'
                                }}
                                onClick={() => handleColorClick(color)}
                            />
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedColors.length} COLORS &lt;&lt;
                    </div>
                    {!isComplete && (
                        <button 
                            className="btn" 
                            disabled={selectedColors.length < 3}
                            onClick={handleSubmit}
                        >
                            [SAVE COLORS]
                        </button>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] COLORS SAVED
                        </div>
                    )}
                </div>
            );
        }

        function EmojiCapture({ onSubmit, isComplete }) {
            const [selectedEmojis, setSelectedEmojis] = useState([]);
            const [availableEmojis] = useState(ALL_EMOJIS.slice(0, 30));

            const handleEmojiClick = (emoji) => {
                if (isComplete) return;
                if (selectedEmojis.includes(emoji)) {
                    setSelectedEmojis(selectedEmojis.filter(e => e !== emoji));
                } else if (selectedEmojis.length < 4) {
                    setSelectedEmojis([...selectedEmojis, emoji]);
                }
            };

            const handleSubmit = () => {
                if (selectedEmojis.length === 4) {
                    onSubmit(selectedEmojis);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT 4 EMOJIS IN ORDER
                    </div>
                    <div className="emoji-grid">
                        {availableEmojis.map(emoji => (
                            <div
                                key={emoji}
                                className={`emoji-box ${selectedEmojis.includes(emoji) ? 'selected' : ''}`}
                                onClick={() => handleEmojiClick(emoji)}
                                style={{ opacity: isComplete ? 0.5 : 1, cursor: isComplete ? 'default' : 'pointer' }}
                            >
                                {emoji}
                            </div>
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedEmojis.length}/4 &lt;&lt;
                    </div>
                    {!isComplete && (
                        <button 
                            className="btn" 
                            disabled={selectedEmojis.length !== 4}
                            onClick={handleSubmit}
                        >
                            [SAVE EMOJIS]
                        </button>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] EMOJIS SAVED
                        </div>
                    )}
                </div>
            );
        }

        function RhythmTapCapture({ onSubmit, isComplete }) {
            const [taps, setTaps] = useState([]);
            const [blinkIndex, setBlinkIndex] = useState(null);

            const handleTap = (circleIndex) => {
                if (isComplete) return;
                const timestamp = Date.now();
                setTaps([...taps, { circleIndex, timestamp }]);
                
                setBlinkIndex(circleIndex);
                setTimeout(() => setBlinkIndex(null), 200);
            };

            const handleClear = () => {
                setTaps([]);
            };

            const handleSubmit = () => {
                if (taps.length >= 3) {
                    onSubmit(taps);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; TAP CIRCLES TO CREATE RHYTHM (MIN 3 TAPS)
                    </div>
                    <div className="rhythm-container">
                        {[0, 1, 2].map(index => (
                            <div
                                key={index}
                                className={`rhythm-circle ${blinkIndex === index ? 'blink' : ''}`}
                                onClick={() => handleTap(index)}
                                style={{ opacity: isComplete ? 0.5 : 1, cursor: isComplete ? 'default' : 'pointer' }}
                            >
                                [{index + 1}]
                            </div>
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; TAPS RECORDED: {taps.length} &lt;&lt;
                    </div>
                    {!isComplete && (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="btn btn-secondary" onClick={handleClear}>
                                [CLEAR]
                            </button>
                            <button 
                                className="btn" 
                                disabled={taps.length < 3}
                                onClick={handleSubmit}
                            >
                                [SAVE RHYTHM]
                            </button>
                        </div>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] RHYTHM SAVED
                        </div>
                    )}
                </div>
            );
        }

        function ImageTapCapture({ onSubmit, isComplete, mode, enrolledTaps }) {
            const [taps, setTaps] = useState([]);
            const [showIndicators, setShowIndicators] = useState([]);
            const containerRef = useRef(null);

            const handleImageClick = (e) => {
                if (isComplete && mode === 'enrollment') return;
                
                const rect = e.currentTarget.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                
                const newTap = { x, y, timestamp: Date.now() };
                setTaps([...taps, newTap]);
                
                const indicator = { x: e.clientX - rect.left, y: e.clientY - rect.top, id: Date.now() };
                setShowIndicators([...showIndicators, indicator]);
                
                setTimeout(() => {
                    setShowIndicators(prev => prev.filter(ind => ind.id !== indicator.id));
                }, 600);
            };

            const handleClear = () => {
                setTaps([]);
            };

            const handleSubmit = () => {
                if (taps.length >= 3) {
                    onSubmit(taps);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        {mode === 'enrollment' 
                            ? '> TAP AT LEAST 3 SPOTS ON IMAGE'
                            : '> TAP THE SAME SPOTS YOU SELECTED'
                        }
                    </div>
                    <div className="image-tap-container" ref={containerRef} onClick={handleImageClick}>
                        <svg className="image-tap-svg" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="400" height="300" fill="#000" stroke="#00ff00" strokeWidth="2"/>
                            <circle cx="100" cy="80" r="40" fill="none" stroke="#00ff00" strokeWidth="2" opacity="0.3"/>
                            <circle cx="300" cy="80" r="40" fill="none" stroke="#00ff00" strokeWidth="2" opacity="0.3"/>
                            <rect x="150" y="120" width="100" height="100" fill="none" stroke="#00ff00" strokeWidth="2" opacity="0.3"/>
                            <polygon points="200,250 150,280 250,280" fill="none" stroke="#00ff00" strokeWidth="2" opacity="0.3"/>
                            <line x1="50" y1="150" x2="350" y2="150" stroke="#00ff00" strokeWidth="1" opacity="0.2"/>
                            <line x1="200" y1="50" x2="200" y2="250" stroke="#00ff00" strokeWidth="1" opacity="0.2"/>
                        </svg>
                        {showIndicators.map(indicator => (
                            <div
                                key={indicator.id}
                                className="tap-indicator show"
                                style={{ left: indicator.x, top: indicator.y }}
                            />
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; TAPS: {taps.length} &lt;&lt;
                    </div>
                    {!isComplete && mode === 'enrollment' && (
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="btn btn-secondary" onClick={handleClear}>
                                [CLEAR]
                            </button>
                            <button 
                                className="btn" 
                                disabled={taps.length < 3}
                                onClick={handleSubmit}
                            >
                                [SAVE TAPS]
                            </button>
                        </div>
                    )}
                    {mode === 'merchant' && (
                        <button 
                            className="btn" 
                            disabled={taps.length < 3}
                            onClick={handleSubmit}
                        >
                            [SUBMIT]
                        </button>
                    )}
                    {isComplete && mode === 'enrollment' && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] TAPS SAVED
                        </div>
                    )}
                </div>
            );
        }

        function GenericCapture({ factor, onSubmit, isComplete }) {
            const [value, setValue] = useState('');

            const handleSubmit = () => {
                if (value.trim()) {
                    onSubmit(value);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; ENTER YOUR {factor.name.toUpperCase()}
                    </div>
                    <input
                        type="text"
                        className="input-field"
                        placeholder={`[${factor.name.toUpperCase()}]`}
                        value={value}
                        onChange={(e) => setValue(e.target.value)}
                        disabled={isComplete}
                    />
                    {!isComplete && (
                        <button 
                            className="btn" 
                            disabled={!value.trim()}
                            onClick={handleSubmit}
                        >
                            [SAVE {factor.name.toUpperCase()}]
                        </button>
                    )}
                    {isComplete && (
                        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '18px' }}>
                            [OK] {factor.name.toUpperCase()} SAVED
                        </div>
                    )}
                </div>
            );
        }

        // ==================== MERCHANT FLOW ====================

        function MerchantFlow() {
            const [stage, setStage] = useState('uuid');
            const [uuid, setUuid] = useState('');
            const [enrollmentData, setEnrollmentData] = useState(null);
            const [challengeFactors, setChallengeFactors] = useState([]);
            const [currentFactorIndex, setCurrentFactorIndex] = useState(0);
            const [verifiedFactors, setVerifiedFactors] = useState({});
            const [timeRemaining, setTimeRemaining] = useState(300);
            const [error, setError] = useState(null);
            const [selectedGateway, setSelectedGateway] = useState(null);
            const [isSuccess, setIsSuccess] = useState(false);

            useEffect(() => {
                if (stage === 'challenge' && timeRemaining > 0) {
                    const timer = setInterval(() => {
                        setTimeRemaining(prev => prev - 1);
                    }, 1000);
                    return () => clearInterval(timer);
                }
                if (timeRemaining === 0) {
                    setError('[TIMEOUT] Session expired. Please start over.');
                    setStage('uuid');
                }
            }, [stage, timeRemaining]);

            const handleUUIDSubmit = () => {
                const data = enrollmentStorage.get(uuid);
                if (data) {
                    setEnrollmentData(data);
                    setError(null);
                    
                    const allFactorIds = Object.keys(data.factors);
                    const factorCount = Math.random() < 0.5 ? 2 : 3;
                    const selectedFactors = shuffleArray(allFactorIds).slice(0, Math.min(factorCount, allFactorIds.length));
                    
                    console.log('🎲 Challenge factors selected:', selectedFactors);
                    console.log('📊 Total enrolled factors:', allFactorIds.length);
                    
                    setChallengeFactors(selectedFactors);
                    setCurrentFactorIndex(0);
                    setVerifiedFactors({});
                    setStage('challenge');
                    setTimeRemaining(300);
                } else {
                    setError('[ERROR] UUID or Alias not found. Please check and try again.');
                }
            };

            const handleFactorSubmit = async (factorId, submittedData) => {
                const enrolledFactor = enrollmentData.factors[factorId];
                let isMatch = false;

                if (factorId === 'PATTERN') {
                    isMatch = patternsAreSimilar(submittedData, enrolledFactor.rawData);
                    console.log(`🔍 Pattern match result: ${isMatch ? '✅ Similar' : '❌ Different'}`);
                } else {
                    const submittedDigest = await sha256(JSON.stringify(submittedData));
                    isMatch = submittedDigest === enrolledFactor.digest;
                }
                
                setVerifiedFactors({
                    ...verifiedFactors,
                    [factorId]: isMatch
                });

                if (!isMatch) {
                    setError(`[ERROR] Authentication failed for ${factorId}. Try again.`);
                    return;
                }

                setError(null);

                if (currentFactorIndex < challengeFactors.length - 1) {
                    setCurrentFactorIndex(currentFactorIndex + 1);
                } else {
                    setIsSuccess(true);
                    
                    if (enrollmentData.gateways.length === 1) {
                        setSelectedGateway(enrollmentData.gateways[0]);
                        setStage('complete');
                    } else {
                        setStage('gateway');
                    }
                }
            };

            const handleGatewaySubmit = () => {
                setStage('complete');
            };

            const handleReset = () => {
                setStage('uuid');
                setUuid('');
                setEnrollmentData(null);
                setChallengeFactors([]);
                setCurrentFactorIndex(0);
                setVerifiedFactors({});
                setTimeRemaining(300);
                setError(null);
                setSelectedGateway(null);
                setIsSuccess(false);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            return (
                <>
                    {stage === 'uuid' && (
                        <div className="ascii-border">
                            <div className="prompt">MERCHANT VERIFICATION</div>
                            <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '16px' }}>
                                &gt; ENTER CUSTOMER UUID OR ALIAS &lt;
                            </div>
                            
                            {error && <div className="error-message">{error}</div>}
                            
                            <input
                                type="text"
                                className="input-field"
                                placeholder="[UUID OR ALIAS]"
                                value={uuid}
                                onChange={(e) => setUuid(e.target.value)}
                            />
                            
                            <button 
                                className="btn" 
                                disabled={!uuid.trim()}
                                onClick={handleUUIDSubmit}
                            >
                                [VERIFY CUSTOMER]
                            </button>

                            <div style={{ textAlign: 'center', marginTop: '15px', fontSize: '14px', color: '#00cc00' }}>
                                [i] Complete enrollment first to get UUID/Alias
                            </div>
                        </div>
                    )}

                    {stage === 'challenge' && enrollmentData && (
                        <MerchantChallenge 
                            enrollmentData={enrollmentData}
                            challengeFactors={challengeFactors}
                            currentFactorIndex={currentFactorIndex}
                            verifiedFactors={verifiedFactors}
                            timeRemaining={timeRemaining}
                            error={error}
                            onFactorSubmit={handleFactorSubmit}
                            formatTime={formatTime}
                        />
                    )}

                    {stage === 'gateway' && (
                        <div className="ascii-border">
                            <div className="prompt">SELECT PAYMENT GATEWAY</div>
                            <div style={{ textAlign: 'center', marginBottom: '15px', fontSize: '16px' }}>
                                &gt; CHOOSE HOW TO COMPLETE PAYMENT &lt;
                            </div>

                            <div className="gateway-grid">
                                {enrollmentData.gateways.map(gatewayId => {
                                    const gateway = PAYMENT_GATEWAYS.find(g => g.id === gatewayId);
                                    return (
                                        <div
                                            key={gateway.id}
                                            className={`gateway-card ${selectedGateway === gateway.id ? 'selected' : ''}`}
                                            onClick={() => setSelectedGateway(gateway.id)}
                                        >
                                            <div className="gateway-icon">{gateway.icon}</div>
                                            <div className="gateway-name">{gateway.name}</div>
                                        </div>
                                    );
                                })}
                            </div>

                            <button 
                                className="btn" 
                                disabled={!selectedGateway}
                                onClick={handleGatewaySubmit}
                            >
                                [COMPLETE PAYMENT]
                            </button>
                        </div>
                    )}

                    {stage === 'complete' && (
                        <div className="success-screen">
                            <div className="ascii-art">
{`
 █████╗ ██╗   ██╗████████╗██╗  ██╗
██╔══██╗██║   ██║╚══██╔══╝██║  ██║
███████║██║   ██║   ██║   ███████║
██╔══██║██║   ██║   ██║   ██╔══██║
██║  ██║╚██████╔╝   ██║   ██║  ██║
╚═╝  ╚═╝ ╚═════╝    ╚═╝   ╚═╝  ╚═╝
`}
                            </div>
                            <div className="success-title">[USER AUTHENTICATED]</div>
                            
                            <div className="info-box" style={{ textAlign: 'left' }}>
                                <div style={{ marginBottom: '8px' }}>
                                    [OK] All factors verified successfully
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    [OK] Gateway: {PAYMENT_GATEWAYS.find(g => g.id === selectedGateway)?.name}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    [OK] Status: SUCCESS
                                </div>
                                <div>
                                    [OK] Time: {new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                                </div>
                            </div>

                            <div className="info-box" style={{ textAlign: 'center', borderColor: '#00cc00' }}>
                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>
                                    [💳]
                                </div>
                                <div style={{ fontSize: '16px' }}>
                                    Transaction handed off to <strong>{PAYMENT_GATEWAYS.find(g => g.id === selectedGateway)?.name}</strong>.<br/>
                                    They'll process the payment.
                                </div>
                            </div>

                            <button className="btn" onClick={handleReset}>
                                [VERIFY ANOTHER CUSTOMER]
                            </button>
                        </div>
                    )}
                </>
            );
        }

        function MerchantChallenge({ enrollmentData, challengeFactors, currentFactorIndex, verifiedFactors, timeRemaining, error, onFactorSubmit, formatTime }) {
            const currentFactorId = challengeFactors[currentFactorIndex];
            const currentFactor = FACTORS.find(f => f.id === currentFactorId);
            const progress = ((currentFactorIndex + 1) / challengeFactors.length) * 100;

            return (
                <div className="ascii-border">
                    <div className="prompt">FACTOR CHALLENGE</div>
                    
                    <div className={`timer ${timeRemaining < 60 ? 'warning' : ''}`}>
                        [⏱] {formatTime(timeRemaining)}
                    </div>

                    <div className="progress-bar">
                        <div className="progress-fill" style={{ width: `${progress}%` }}>
                            {Math.round(progress)}%
                        </div>
                    </div>

                    <div style={{ textAlign: 'center', margin: '15px 0', fontSize: '18px' }}>
                        &gt; FACTOR {currentFactorIndex + 1} OF {challengeFactors.length}: {currentFactor.name.toUpperCase()} &lt;
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    <MerchantFactorChallenge 
                        factor={currentFactor}
                        enrolledData={enrollmentData.factors[currentFactorId].rawData}
                        onSubmit={(data) => onFactorSubmit(currentFactorId, data)}
                    />
                </div>
            );
        }

        function MerchantFactorChallenge({ factor, enrolledData, onSubmit }) {
            switch (factor.id) {
                case 'PIN':
                    return <PinCapture onSubmit={onSubmit} isComplete={false} />;
                case 'PATTERN':
                    return <PatternCapture onSubmit={onSubmit} isComplete={false} />;
                case 'WORDS':
                    return <WordsMerchantChallenge enrolledData={enrolledData} onSubmit={onSubmit} />;
                case 'COLOUR':
                    return <ColorMerchantChallenge enrolledData={enrolledData} onSubmit={onSubmit} />;
                case 'EMOJI':
                    return <EmojiMerchantChallenge enrolledData={enrolledData} onSubmit={onSubmit} />;
                case 'RHYTHM_TAP':
                    return <RhythmTapCapture onSubmit={onSubmit} isComplete={false} />;
                case 'IMAGE_TAP':
                    return <ImageTapCapture onSubmit={onSubmit} isComplete={false} mode="merchant" enrolledTaps={enrolledData} />;
                default:
                    return <GenericCapture factor={factor} onSubmit={onSubmit} isComplete={false} />;
            }
        }

        function EmojiMerchantChallenge({ enrolledData, onSubmit }) {
            const [selectedEmojis, setSelectedEmojis] = useState([]);
            const [shuffledEmojis, setShuffledEmojis] = useState([]);

            useEffect(() => {
                const enrolled = enrolledData;
                const remaining = shuffleArray(ALL_EMOJIS.filter(e => !enrolled.includes(e))).slice(0, 8);
                const grid = shuffleArray([...enrolled, ...remaining]);
                setShuffledEmojis(grid);
            }, [enrolledData]);

            const handleEmojiClick = (emoji) => {
                if (selectedEmojis.includes(emoji)) {
                    setSelectedEmojis(selectedEmojis.filter(e => e !== emoji));
                } else if (selectedEmojis.length < 4) {
                    setSelectedEmojis([...selectedEmojis, emoji]);
                }
            };

            const handleSubmit = () => {
                if (selectedEmojis.length === 4) {
                    onSubmit(selectedEmojis);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT YOUR 4 EMOJIS IN ORDER
                    </div>
                    <div className="emoji-grid">
                        {shuffledEmojis.map(emoji => (
                            <div
                                key={emoji}
                                className={`emoji-box ${selectedEmojis.includes(emoji) ? 'selected' : ''}`}
                                onClick={() => handleEmojiClick(emoji)}
                            >
                                {emoji}
                            </div>
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedEmojis.length}/4 &lt;&lt;
                    </div>
                    <button 
                        className="btn" 
                        disabled={selectedEmojis.length !== 4}
                        onClick={handleSubmit}
                    >
                        [SUBMIT]
                    </button>
                </div>
            );
        }

        function WordsMerchantChallenge({ enrolledData, onSubmit }) {
            const [selectedWords, setSelectedWords] = useState([]);
            const [shuffledWords, setShuffledWords] = useState([]);

            useEffect(() => {
                const enrolled = enrolledData;
                const remaining = shuffleArray(WORD_LIST.filter(w => !enrolled.includes(w))).slice(0, 8);
                const grid = shuffleArray([...enrolled, ...remaining]);
                setShuffledWords(grid);
            }, [enrolledData]);

            const handleWordClick = (word) => {
                if (selectedWords.includes(word)) {
                    setSelectedWords(selectedWords.filter(w => w !== word));
                } else if (selectedWords.length < 4) {
                    setSelectedWords([...selectedWords, word]);
                }
            };

            const handleSubmit = () => {
                if (selectedWords.length === 4) {
                    onSubmit(selectedWords);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT YOUR 4 WORDS IN ORDER
                    </div>
                    <div className="word-grid">
                        {shuffledWords.map(word => (
                            <div
                                key={word}
                                className={`word-box ${selectedWords.includes(word) ? 'selected' : ''}`}
                                onClick={() => handleWordClick(word)}
                            >
                                {word.toUpperCase()}
                            </div>
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedWords.length}/4 &lt;&lt;
                    </div>
                    <button 
                        className="btn" 
                        disabled={selectedWords.length !== 4}
                        onClick={handleSubmit}
                    >
                        [SUBMIT]
                    </button>
                </div>
            );
        }

        function ColorMerchantChallenge({ enrolledData, onSubmit }) {
            const [selectedColors, setSelectedColors] = useState([]);
            const [shuffledColors] = useState(shuffleArray(COLORS));

            const handleColorClick = (color) => {
                if (selectedColors.includes(color)) {
                    setSelectedColors(selectedColors.filter(c => c !== color));
                } else if (selectedColors.length < enrolledData.length) {
                    setSelectedColors([...selectedColors, color]);
                }
            };

            const handleSubmit = () => {
                if (selectedColors.length === enrolledData.length) {
                    onSubmit(selectedColors);
                }
            };

            return (
                <div>
                    <div style={{ marginBottom: '10px', fontSize: '16px' }}>
                        &gt; SELECT YOUR COLORS IN ORDER
                    </div>
                    <div className="color-grid">
                        {shuffledColors.map(color => (
                            <div
                                key={color}
                                className={`color-box ${selectedColors.includes(color) ? 'selected' : ''}`}
                                style={{ backgroundColor: color }}
                                onClick={() => handleColorClick(color)}
                            />
                        ))}
                    </div>
                    <div style={{ textAlign: 'center', margin: '10px 0', fontSize: '16px' }}>
                        &gt;&gt; SELECTED: {selectedColors.length}/{enrolledData.length} &lt;&lt;
                    </div>
                    <button 
                        className="btn" 
                        disabled={selectedColors.length !== enrolledData.length}
                        onClick={handleSubmit}
                    >
                        [SUBMIT]
                    </button>
                </div>
            );
        }

        // ==================== RENDER ====================

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>